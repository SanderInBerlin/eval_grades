---
title: "SanderBeerepoot"
format: html
---

link to github: https://github.com/SanderInBerlin/eval_grades.git

```{r}
library(here)
library(vroom)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
```

```{r}
here::i_am("eval_grades.Rproj")
```

```{r}
courses <- vroom(here("courses.csv"))
```

Question 2
Display the content of the file in a nicely formatted table in your document. Courses should be
sorted in alphabetical order and column names should be written in English. This has to be
done in R for instance using knitr::kable().

```{r}
formatted_courses <-
courses |>
  rename(Course_name = course,
         identifier = course_id,
         module = module,
         `number of exams` = nb_grades)|>
  arrange(Course_name)
knitr::kable(formatted_courses)
```
```{r}
students <- 
  vroom(here("students.csv"))
```
to have group loaded as a factor and id as an integer.
Question 3
Load the student data set. Make sure the birth dates are correctly identified as Date objects by
including the class of the corresponding column in the rendered text. For instance, include a
sentence of the following form:
The birth_date column of the students data frame is of class Date.
Make also sure that the sex is identified as a factor.
```{r}
students_typed <- students |>
  mutate(
    birth_date = as.Date(birth_date, format = "%Y-%m-%d"),
    group = as.factor(group),
    sex = as.factor(sex),
    id = as.integer(id)
  )
```

```{r}
grades <- vroom(here("grades.csv"))
cols(
  id = col_double(),
  course_id = col_double(),
  grade = col_double())
```
Question 4

```{r}
ok_grades <- read_delim(here("grades.csv"),
  delim = "|"
)
cols(
  id = col_double(),
  course_id = col_double(),
  grade = col_double())
```
Question 5: Use a graphical representation to display the number of students per group.
```{r}
students_typed |>
  group_by(group)|>
  summarise(n = n())|>
  ggplot(aes(x = n)) +
  geom_bar()
```
 Question 6: Show the gender balance in each group on a single graphical representation.
```{r}
students_typed|>
  ggplot(aes(x = group, fill = sex)) +
  geom_bar(position = "fill")
```

Question 7
Show graphically the distribution of the age of the students.

```{r}
students_age <- students|>
  mutate(age_years = as.numeric(Sys.Date() - birth_date) / 365.25)
students_age |>
ggplot(aes(x = age_years)) +
  geom_density()
  

```
Question 8
Compute the median age of the students in each group and include in your rendering a table
giving the median age for each group. The median should be reported as an integer.

```{r}
students_age |>
  group_by(group)|>
  summarise(median = median(age_years))
```
Question 9: Build a table with the id, sex and age of the oldest student in each group. Sort the table by
decreasing age order and include it in the rendering.
```{r}

val_per_oldest <- students_age |>
  group_by(group)|>
  slice_max(age_years, n = 1, with_ties = TRUE) |>
  ungroup() |>
  
  select(id, sex, group, Age_Years = age_years) |>
  arrange(desc(Age_Years))
val_per_oldest|>
  knitr::kable()
```
3 Simple grade analysis

Question 10

Give the number of grades in the data set directly in the text of your quarto file, in a sentence
of the form “The data set contains xxx grades.” where xxx is replaced by the number of grades.
This must be computed from the data set. Note that missing grades should obviously not be
included in the total.

```{r}
number_of_grades <- grades |>
  filter(!is.na(grade)) |>
  summarise(
    n = n()
  ) |>
  pull(n)

"The dataset contains `{n} number_of_grades` grades"
```
The value is shown in the values part of the global environment

Question 11

Question 11
Compute the average of all the grades in Neurotechnology and Mind Control in each group and
display graphically this average as a function of the group. It is recommend to use geom_col()
for this task (read the documentation!).

```{r}
course_id_neurotech <- courses |>
  filter(course == "Neurotechnology and Mind Control") |>
  pull(course_id)

avg_grades_by_group <- grades |>
  filter(course_id == course_id_neurotech) |>
  left_join(students, by = "id") |>
  group_by(group)|>
  summarise(
    avg_grade = mean(grade, na.rm = TRUE))

avg_grades_by_group|>
  ggplot(aes(y = avg_grade, x = group)) +
  geom_col()
```

Question 12
Compare graphically the distribution of the grades of the 2 modules.
```{r}
grades_with_module <- grades|>
  filter(!is.na(grade))|>
  
  left_join(courses, by = "course_id") |>
  mutate(module = as.factor(module))
 grades_with_module|>
  ggplot(aes(x = module, y = grade, fill = module)) +
  geom_boxplot()
```
Question 13
Compute the number of grades per student and include in your quarto rendering an extract of
the resulting data frame. Make sure to keep in the data frame the id of the students but also
their group and their sex. Include in the text a markdown table with the minimum, maximum,
average and median number of grades per student.
```{r}
grades_per_student <- grades |>
  group_by(id) |>
  summarise(
    nb_grades = n()
  )

students_with_grades_count <- students |>
  left_join(grades_per_student, by = "id") |>
  mutate(nb_grades = replace_na(nb_grades, 0))
 students_with_grades_count |>
  summarise(
    Minimum = min(nb_grades),
    Maximum = max(nb_grades),
    Average = mean(nb_grades),
    Median = median(nb_grades)
  ) |>
   pivot_longer(
    cols = everything(),
    names_to = "Metric",
    values_to = "Number of Grades"
  )|>
  knitr::kable()
```

Question 14: 
Compare graphically the distribution of the number of grades for female and male students.

```{r}
students_with_grades_count <- grades |>
  group_by(id) |>
  summarise(
    nb_grades = n()
  ) |>
  left_join(students, by = "id") |>
  mutate(nb_grades = replace_na(nb_grades, 0))
 students_with_grades_count |>
  ggplot(aes(x = nb_grades, fill = sex)) +
  geom_density(alpha = 0.5)
```
Question 15:
Create a data frame that gives for each student their id, their group and the number of grades
they obtained in Cybernetic Implants and Augmentations and include in the quarto rendering a
small extract of the result.

```{r}
course_id_target <- 1 

grades_count_course <- grades |>
  filter(course_id == course_id_target, !is.na(grade))|>
  group_by(id) |>
  summarise(
    nb_grades_course = n(),
    .groups = 'drop'
  )
 students |>
  left_join(grades_count_course, by = "id") |>
  mutate(nb_grades_course = replace_na(nb_grades_course, 0)) |>
   slice_head(n = 5) |>
    knitr::kable()
```
Question 16: Compute from the previous data frame the distribution of the number of grades, that is for each
number of grades (e.g. 10) the number of students who have exactly this number of grades in
Cybernetic Implants and Augmentations. Represent graphically the results.

```{r}
students_course_grades_count <- grades |>
  filter(course_id == course_id_target, !is.na(grade)) |>
  group_by(id) |>
  summarise(nb_grades_course = n(), .groups = 'drop') |>
  left_join(students, by = "id") |>
  mutate(nb_grades_course = replace_na(nb_grades_course, 0))

grades_distribution <- students_course_grades_count |>
  count(nb_grades_course, name = "nb_students") |>
  mutate(nb_grades_course = as.factor(nb_grades_course)) 

 grades_distribution |>
  ggplot(aes(x = nb_grades_course, y = nb_students)) +
  geom_col()
```
Question 17: 
```{r}
course_id_target <=1
grades_count_course <- grades |>
  filter(course_id == course_id_target, !is.na(grade)) |>
  group_by(id)|>
  summarise(nb_grades_course = n())
students_course_grades_count <- students |>
  left_join(grades_count_course, by = "id") |>
  mutate(nb_grades_course = replace_na(nb_grades_course, 0))
 students_course_grades_count|>
  ggplot(aes(x = as.factor(group), y = nb_grades_course,)) +
  geom_violin() 
```
Question 18
Take the analysis of the previous question one step further to see if there is a dependency of the
number of grades with respect to both the group and the sex of the students.

```{r}
 students_course_grades_count|>
  ggplot(aes(x = as.factor(group), y = nb_grades_course)) +
  geom_violin() +
  facet_wrap(vars(sex))
```
Question 19: 
5 Grade analysis
Question 19
Create a data frame that gives for each student their id, their group and the average of grades
they obtained in each course. Using an adapted pivoting method, create a new data frame
with one row per student and 12 columns: one for the id, one for the group and one per course.
Include in the quarto rendering a small extract of the data frame with the id and group columns
and with two of the course columns. 

```{r}
avg_grades_long <- grades |>
  left_join(students, by = "id") |>
  group_by(id, group, course_id) |>
  summarise(
    avg_grade = mean(grade, na.rm = TRUE)
  )

students_avg_grades_pivoted <- avg_grades_long|>
  pivot_wider(
    names_from = course_id,
    values_from = avg_grade
  )
  
students_avg_grades_pivoted |>
  slice_head(n = 5)|>
  knitr::kable()
```

Question 20: 
Show the average grades in Corporate Espionage and Industrial Sabotage as a function of the
average grades in Urban Planning and Megacity Design. Make sure to maximise the readability
of the proposed representation.

```{r}
avg_grades_long <- grades |>
  group_by(id, course_id) |>
  summarise(
    avg_grade = mean(grade, na.rm = TRUE)
  )

students_avg_grades_pivoted <- avg_grades_long |>
  pivot_wider(
    id_cols = id,
    names_from = course_id,
    values_from = avg_grade
  )

course_x_id <- "7"
course_y_id <- "9" 
 students_avg_grades_pivoted |>
  ggplot(aes(x = `7`, y = `9`)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", se = TRUE, color = "red", linewidth = 1) +
  labs(
    title = paste("Average Grades: Corporate Espionage (Y) vs. Urban Planning (X)"),
    x = "Average Grade in Urban Planning and Megacity Design (Course 7)",
    y = "Average Grade in Corporate Espionage and Industrial Sabotage (Course 9)"
  ) +
  
  theme_minimal()
```
Question 21: 
The cor() function computes the correlation coeﬀicient between two vectors. It can be used
as a summary function in dplyr. Using it, compute the correlation between the average grades
in Post-Human Philosophy and Ethics and the average grades in Hacking and Network Security
group by group.

```{r}
avg_grades_long <- grades |>
  left_join(students, by = "id") |>
  group_by(id, group, course_id) |>
  summarise(
    avg_grade = mean(grade, na.rm = TRUE)
  )


students_avg_grades_pivoted2 <- avg_grades_long|>
  pivot_wider(
    id_cols = c(id, group),   
    names_from = course_id,
    values_from = avg_grade
  ) |>
  rename_with(~ paste0("C", .x), .cols = matches("^[0-9]+$"))

students_avg_grades_pivoted2 |>
  group_by(group) |>
  summarise(
    correlation_coefficient = cor(`C10`, `C2`, use = "complete.obs")
  ) |>
  rename(`Correlation (C10 vs. C2)` = correlation_coefficient)
```
Question 22: Display the average grades in Post-Human Philosophy and Ethics as a function the average
grades in Hacking and Network Security for the students of the group in which those grades are
the most correlated (positively or negatively).

```{r}
course_x_id <- "2" 
course_y_id <- "10" 
correlation_by_group <- students_avg_grades_pivoted2 |>
  group_by(group) |>
  summarise(
    correlation_coefficient = cor(`C10`, `C2`, use = "complete.obs")
  )
target_group_row <- correlation_by_group |>
  mutate(abs_corr = abs(correlation_coefficient))|>
  slice_max(abs_corr, n = 1)

target_group <- as.integer(target_group_row$group)
target_corr <- target_group_row$correlation_coefficient

df_target <- students_avg_grades_pivoted2 |>
  filter(group == target_group)
course_names <- vroom(here("courses.csv"))
course_x_name <- course_names |> filter(course_id == 2) |> pull(course)
course_y_name <- course_names |> filter(course_id == 10) |> pull(course)

df_target |>
  ggplot(aes(x = `C2`, y = `C10`)) +
  geom_point(alpha = 0.8, size = 3, color = "darkblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red", linewidth = 1) 
```
Question 23: Let us assume that the final grade of a student is the average of the averages of their grades for
each course. Create a data frame with four columns, id, group, sex and final grade based on
this definition for the last column. Sort the data frame in decrease order of final grade and
include in the quarto rendering its first five rows.

```{r}
df_avg_course_grade <- grades |>
  group_by(id, course_id) |>
  summarise(
    avg_course_grade = mean(grade, na.rm = TRUE))

df_final_grade <- df_avg_course_grade|>
  group_by(id) |>
  summarise(
    final_grade = mean(avg_course_grade, na.rm = TRUE)
  )

 students |>
  select(id, group, sex) |>
  left_join(df_final_grade, by = "id")|>
  arrange(desc(final_grade))|>
   slice_head(n = 5)|>
   knitr::kable()
```
question 24: 
Find a way to study differences in final grades between groups.
```{r}
 df_final <- students |>
  select(id, group, sex) |>
  left_join(df_final_grade, by = "id")|>
  arrange(desc(final_grade))
 df_final |>
  ggplot(aes(x = as.factor(group), y = final_grade)) +
  
  geom_boxplot(
  )
```
Quetsion 25: Include in the analysis conducted in the previous question the effect of sex.
```{r}
 df_final <- students |>
  select(id, group, sex) |>
  left_join(df_final_grade, by = "id")|>
  arrange(desc(final_grade))
 df_final |>
  ggplot(aes(x = as.factor(group), y = final_grade)) +
  geom_boxplot() +
   facet_wrap(vars(sex))
```
Question 26: To pass the year, a student must fulfil the following conditions:
• have no average grade in a course lower than 5;
7
• have an average grade in each module larger or equal to 10 (the average in a module is
simply the average of the average grades of the courses in the module).
Create a data frame that gives for each student their id, their group, their final grade (as
defined before) and a pass variable equal to TRUE if the student pass the year (and FALSE if they
do not).


```{r}
df_pass_c1 <- df_avg_course_grade |>
  group_by(id) |>
  summarise(pass_c1 = min(avg_course_grade, na.rm = TRUE) >= 5)
df_module_avg_grades <- df_avg_course_grade |>
  left_join(courses |> select(course_id, module), by = "course_id")

df_module_avg <- df_module_avg_grades |>
  group_by(id, module) |>
  summarise(avg_module_grade = mean(avg_course_grade, na.rm = TRUE))

df_pass_c2 <- df_module_avg|>
  group_by(id) |>
  summarise(pass_c2 = min(avg_module_grade, na.rm = TRUE) >= 10)

df_final_pass <- students |>
  select(id, group, sex)|>
  left_join(df_final_grade, by = "id") |>
  left_join(df_pass_c1, by = "id") |>
  left_join(df_pass_c2, by = "id") |>
  mutate(pass = pass_c1 & pass_c2) |>
  select(id, group, final_grade, pass)
print(df_final_pass)
```

